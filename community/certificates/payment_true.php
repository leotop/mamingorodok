<?$LAST_DAY = 0;$_SERVER["DOCUMENT_ROOT"] = "/data/mamingorodok.ru/docs/";$report_file = $_SERVER["DOCUMENT_ROOT"].'/assist_report.txt';require($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_before.php");define("NO_KEEP_STATISTIC", true);define("NOT_CHECK_PERMISSIONS",true);set_time_limit (0);define("LANG","ru");$DOCUMENT_ROOT = $_SERVER["DOCUMENT_ROOT"];Report("\n\n\nНачинаем импорт отчетов проплаты");//require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_before.php");Report("Инициализируем переменные");CModule::IncludeModule("sale");$dbPaySysAction = CSalePaySystemAction::GetList(					array(),					array(							"PAY_SYSTEM_ID" => 4,							"PERSON_TYPE_ID" => 1						),					false,					false,					array("PARAMS")				);$ArAction =$dbPaySysAction->Fetch();if(strlen($ArAction['PARAMS'])<=0)	Report("Ошибка в инициализации переменных",1);	$ArParams = CSalePaySystemAction::UnSerializeParams($ArAction['PARAMS']);$SHOP_IDP = $ArParams['PAYMENT_Merchant_ID']['VALUE'];if($SHOP_IDP <= 0)	Report("Не установлен идентификатор магазина",1);$SHOP_LOGIN = $ArParams['PAYMENT_Login']['VALUE'];if(strlen($SHOP_LOGIN) <= 0)	Report("Не установлен логин магазина",1);	$SHOP_PASSWORD = $ArParams['PAYMENT_Password']['VALUE'];if(strlen($SHOP_PASSWORD) <= 0)	Report("Не установлен пароль магазина",1);$curtime = time();$lasttime = AddToTimeStamp(array('DD'=>$LAST_DAY),$curtime);$DD = date('d',$lasttime);$MM = date('m',$lasttime);$YYYY = date('Y',$lasttime);$nowtime = AddToTimeStamp($curtime);$DD2 = date('d',$nowtime);$MM2 = date('m',$nowtime);$YYYY2 = date('Y',$nowtime);$sHost = "payments.paysecure.ru";$sUrl = "/resultbydate/resultbydate.cfm";$sVars = "Merchant_ID=".$SHOP_IDP."&Login=".$SHOP_LOGIN."&Password=".$SHOP_PASSWORD."&TestMode=1&Format=3&StartDay=".$DD."&StartMonth=".$MM."&StartYear=".$YYYY."&StartHour=00&StartMin=00&EndDay=".$DD2."&EndMonth=".$MM2."&EndYear=".$YYYY2."&EndHour=23&EndMin=59";$aDesc["AS000"]="АВТОРИЗАЦИЯ УСПЕШНО ЗАВЕРШЕНА";$aDesc["AS001"]="АВТОРИЗАЦИЯ УСПЕШНО ЗАВЕРШЕНА (С CVC2)";$aDesc["AS010"]="ПРЕДАВТОРИЗАЦИЯ УСПЕШНО ЗАВЕРШЕНА";$aDesc["AS011"]="ПРЕДАВТОРИЗАЦИЯ УСПЕШНО ЗАВЕРШЕНА (С CVC2)";$aDesc["AS020"]="ПОСТАВТОРИЗАЦИЯ УСПЕШНО ЗАВЕРШЕНА";$aDesc["AS100"]="ОТКАЗ В АВТОРИЗАЦИИ";$aDesc["AS101"]="ОТКАЗ В АВТОРИЗАЦИИ. Ошибочный номер платежного средства";$aDesc["AS102"]="ОТКАЗ В АВТОРИЗАЦИИ. Недостаточно средств";$aDesc["AS104"]="ОТКАЗ В АВТОРИЗАЦИИ. Неверный срок действия карты";$aDesc["AS105"]="ОТКАЗ В АВТОРИЗАЦИИ. Превышен лимит";$aDesc["AS106"]="ОТКАЗ В АВТОРИЗАЦИИ. Неверный PIN";$aDesc["AS107"]="ОТКАЗ В АВТОРИЗАЦИИ. Ошибка приема данных";$aDesc["AS108"]="ОТКАЗ В АВТОРИЗАЦИИ. Подозрение на мошенничество";$aDesc["AS109"]="ОТКАЗ В АВТОРИЗАЦИИ. Превышен лимит операций Assist";$aDesc["AS200"]="ПОВТОРИТЕ АВТОРИЗАЦИЮ";$aDesc["AS300"]="АВТОРИЗАЦИЯ В ПРОЦЕССЕ. ЖДИТЕ";$aDesc["AS400"]="ПЛАТЕЖА С ТАКИМИ ПАРАМЕТРАМИ НЕ СУЩЕСТВУЕТ";$aDesc["AS998"]="ОШИБКА СИСТЕМЫ. Свяжитесь с ASSIST";$aSuccess = array("AS000", "AS001", "AS010", "AS011", "AS020");$ArResultFields=array("ordernumber","response_code","recommendation","message","comment","date","total","currency","cardtype","cardnumber","lastname","firstname","middlename","address","email","country","rate","approvalcode","cardsubtype","cvc2","cardholder","ipaddress","protocoltypename","billnumber","bankname","status","error_code","error_comment","packetdate","signature","processingname","paymenttransactiontype_id",);	        			if ($USER->IsAuthorized()) {	$saveUser = $USER->GetID();}		$rsUser = CUser::GetByLogin("AssistCron");$arUser = $rsUser->Fetch();if(!isset($arUser['ID']) || $arUser['ID'] <=0 )	Report("Не найден соответствующий роботу пользователь CMS",1);$IsAuth = $USER->Authorize($arUser['ID']); if(!$IsAuth)	Report("Не авторизован соответствующий роботу пользователь CMS",1);	Report("Отсылаем запрос от ({$DD}.{$MM}.{$YYYY}) к серверу Assist");//print_R($sVars);$sResult = QueryGetData($sHost, 80, $sUrl, $sVars, $errno, $errstr,"POST"); //print_R("atvet ".htmlspecialchars($sResult));$len = strlen($sResult);Report("Длина ответа $len байт", ($len<10 ? 1 : 0));global $APPLICATION;$sResult = $APPLICATION->ConvertCharset($sResult,"UTF-8","Windows-1251");require_once($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/classes/general/xml.php");$objXML = new CDataXML();$objXML->LoadString($sResult);$arResult = $objXML->GetArray();//if($arResult["result"]["@"]["count"]>0){	//print_R($arResult);	Report("Начинаем разбор");	$temp = tmpfile();	fwrite($temp, $sResult);	fseek($temp, 0);			$result_array = array();	$i = 0;		foreach($arResult["result"]["#"]["payment"] as $k=>$p){		$ORDER_ID = $p["#"]["ordernumber"][0]["#"];			Report("Заказ N $ORDER_ID : {$aDesc[$p["#"]["responsecode"][0]["#"]]}");		if($ORDER_ID>0)		{			Report("Платеж N {$p["#"]["billnumber"][0]["#"]} от {$p["#"]["packetdate"][0]["#"]} обновляем базу");			$arFields = array(						"PS_STATUS" => (in_array($p["#"]["responsecode"][0]["#"], $aSuccess)?"Y":"N"),						"PS_STATUS_CODE" => $p["#"]["responsecode"][0]["#"],						"PS_STATUS_DESCRIPTION" => $aDesc[$p["#"]["responsecode"][0]["#"]],						"PS_STATUS_MESSAGE" => $p["#"]["recommendation"][0]["#"],						"PS_SUM" => DoubleVal( $p["#"]["orderamount"][0]["#"]),						"PS_CURRENCY" => $p["#"]["ordercurrency"][0]["#"],						"PS_RESPONSE_DATE" => Date(CDatabase::DateFormatToPHP(CLang::GetDateFormat("FULL", LANG))),						"PAY_VOUCHER_NUM" => $p["#"]["billnumber"][0]["#"], 						"PAY_VOUCHER_DATE"=>	$p["#"]["packetdate"][0]["#"]					); 																	$res = CSaleOrder::PayOrder($ORDER_ID, 'Y', true, true, 0, $arFields);			if(!$res) 			{  				$ex = $APPLICATION->GetException();				$strError = $ex->GetString();				Report($strError);			}			else 				Report("Успешно обновили\n\n");		}	}}// $pos = strpos($sResult, 'ERROR');// if ($pos !== false) 	// Report($sResult, 1);		$USER->Logout();$USER->Authorize($saveUser); LocalRedirect("/community/user/".$saveUser."/certificates/already-have/");Report("Закончили разбор",1);function Report($str, $end = 0){	global $report_file;	$str = date('[d.m.Y H:i:s] ').$str."\n";	$fp = fopen($report_file,'a');	if($fp)	{		fputs($fp,$str);		fclose($fp);	}	echo str_replace("\n","<br>",$str);	if($end)		die();}  ?>