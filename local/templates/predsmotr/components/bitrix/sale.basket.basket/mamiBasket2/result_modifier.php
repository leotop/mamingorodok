<?if(count($arResult["ITEMS"]["AnDelCanBuy"])<=0){	unset($_SESSION["PRODUCTS"]);	unset($_SESSION["certificates"]);}foreach($arResult["ITEMS"]["AnDelCanBuy"] as $k=>$arBasketItems){	$arFilter = Array(       		"ID"=>$arBasketItems["PRODUCT_ID"],    		"ACTIVE"=>"Y",      	);		//xvar_dump($arBasketItems);			$res = CIBlockElement::GetList(Array("ID"=>"ASC"), $arFilter, false, array('nTopCount'=>1), array("PROPERTY_CML2_LINK","PROPERTY_PICTURE_MIDI"));		if($ar_fields = $res->GetNext()){  		//print_R($ar_fields);			//echo CFile::GetPath($ar_fields["PROPERTY_PICTURE_MIDI_VALUE"]);		$arResult["ITEMS"]["AnDelCanBuy"][$k]["IMAGE"] = $ar_fields["PROPERTY_PICTURE_MIDI_VALUE"];		$arFilter2 = Array(       		"ID"=>$ar_fields["PROPERTY_CML2_LINK_VALUE"],    		"ACTIVE"=>"Y",      		);		$res2 = CIBlockElement::GetList(Array("ID"=>"ASC"), $arFilter2, false, array('nTopCount'=>1), array("PROPERTY_RATING"));		if($ar_fields2 = $res2->GetNext()){					$arResult["ITEMS"]["AnDelCanBuy"][$k]["RATING"] = $ar_fields2["PROPERTY_RATING_VALUE"];					}	}	}		global $USER;	if($USER->IsAuthorized()){	$arFilter = Array(       		"IBLOCK_ID"=>CERTIFICATES_IBLOCK_ID,    		"ACTIVE"=>"Y",		"PROPERTY_HAVE"=>$USER->GetID()	);		$res = CIBlockElement::GetList(Array("SORT"=>"ASC"), $arFilter, false, false, array("*"));		while($ar_fields = $res->GetNextElement()){  		$db_props = $ar_fields->GetProperties();		$db_field = $ar_fields->GetFields();			//$ar_props; 		//print_R($db_props);		$CERT = "";		foreach($db_props["HAVE"]["VALUE"] as $k=>$have)			{				if($have==$USER->GetID()){					if(intval($db_props["HAVE"]["DESCRIPTION"][$k])>0)						$CERT = array(						"ID"=> $db_field["ID"],						"NAME"=> $db_field["NAME"],						"PICTURE"=> $db_field["PREVIEW_PICTURE"],						"PRICE"=> $db_props["PRICE"]["VALUE"],						"COUNT"=> $db_props["HAVE"]["DESCRIPTION"][$k]						);				}							}						if(is_array($CERT))			$arResult["CERT"][] = $CERT;	}		}		$sale = 0;	if(isset($_SESSION["certificates"]) && !empty($_SESSION["certificates"]) && is_array($_SESSION["certificates"]) && count($_SESSION["certificates"])>0){				foreach($_SESSION["certificates"] as $k=>$val){			$price = 0;			$db_props = CIBlockElement::GetProperty(CERTIFICATES_IBLOCK_ID, $k, array("sort" => "asc"), Array("CODE"=>"PRICE"));			if($ar_props = $db_props->Fetch())					$price = IntVal($ar_props["VALUE"]);			$sale += $price*$val;		}	}		$arResult["SALE"] = $sale;?>