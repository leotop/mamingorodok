<?//unset($_SESSION["certificates"]);	global $USER;		$user_id = $USER->GetID();	$arFilter = Array(       		"IBLOCK_ID"=>CERTIFICATES_IBLOCK_ID,    		"ACTIVE"=>"Y",		"PROPERTY_HAVE"=>$user_id,	);	$res = CIBlockElement::GetList(Array("SORT"=>"ASC"), $arFilter, false, false, array("*"));		while($ar_fields = $res->GetNextElement()){				$db_props = $ar_fields->GetProperties();		$db_field = $ar_fields->GetFields();				$CERT = "";		foreach($db_props["HAVE"]["VALUE"] as $k=>$have){			$ar_props = array();			if($have==$user_id){					$CERT = array(						"ID"=> $db_field["ID"],						"NAME"=> $db_field["NAME"],						"PICTURE"=> $db_field["PREVIEW_PICTURE"],						"PRICE"=> $db_props["PRICE"]["VALUE"],						"COUNT"=> $db_props["HAVE"]["DESCRIPTION"][$k]					);								}		}				if(is_array($CERT)){			$arResult["CERT"][] = $CERT;		}			}			$sale = 0;		if(isset($_SESSION["certificates"]) && !empty($_SESSION["certificates"]) && is_array($_SESSION["certificates"]) && count($_SESSION["certificates"])>0){						foreach($_SESSION["certificates"] as $k=>$val){				$price = 0;				$db_props = CIBlockElement::GetProperty(CERTIFICATES_IBLOCK_ID, $k, array("sort" => "asc"), Array("CODE"=>"PRICE"));				if($ar_props = $db_props->Fetch())						$price = IntVal($ar_props["VALUE"]);				$sale += $price*$val;			}		}							$arResult["SALE"] = $sale;	if($arResult["POST"]["CurrentStep"]==3 || $arResult["POST"]["CurrentStep"]==4){		$dbBasketItems = CSaleBasket::GetList(				array("NAME" => "ASC"),				array(						"FUSER_ID" => CSaleBasket::GetBasketUserID(),						"LID" => SITE_ID,						"ORDER_ID" => "NULL"					)			);			$count  = 0;			$prices = 0;		while ($arBasketItems = $dbBasketItems->Fetch())		{			$count +=$arBasketItems["QUANTITY"];			$prices += ($arBasketItems["PRICE"]*$arBasketItems["QUANTITY"]);		}				$arResult["DELIVERY_NOW"] = $arResult["DELIVERY"][0]["PRICE"];		$arResult["BASKET"]["COUNT"] = $count;		$arResult["BASKET"]["PRICE"] = $prices-$sale;					}if($arResult["POST"]["CurrentStep"]==5){	//print_R($arResult);	foreach($arResult["BASKET_ITEMS"] as $k=>$arBasketItems)	{			//xvar_dump($arBasketItems);			$arFilter = Array(       			"ID"=>$arBasketItems["PRODUCT_ID"],    			"ACTIVE"=>"Y",      		);		$res = CIBlockElement::GetList(Array("ID"=>"ASC"), $arFilter, false, array('nTopCount'=>1), array( "PROPERTY_MAIN_PRODUCT"));		if($ar_fields = $res->GetNext()	)	{  		//$arResult["BASKET_ITEMS"][$k]["IMAGE"] = $ar_fields["PROPERTY_PICTURE_MINI_VALUE"];		//$arResult["BASKET_ITEMS"][$k]["IMAGE"] = CFile::GetPath($ar_fields["PROPERTY_PICTURE_MINI_VALUE"]);		//$arResult["BASKET_ITEMS"][$k]["COLOR"] = $ar_fields["PROPERTY_COLOR_VALUE"];		//$arResult["BASKET_ITEMS"][$k]["SIZE"] = $ar_fields["PROPERTY_SIZE_VALUE"];		//$arResult["BASKET_ITEMS"][$k]["NAME"] = $ar_fields["NAME"];		$arFilter2 = Array(       		"ID"=>$ar_fields["PROPERTY_MAIN_PRODUCT_VALUE"],    		"ACTIVE"=>"Y",      		);		$res2 = CIBlockElement::GetList(Array("ID"=>"ASC"), $arFilter2, false, array('nTopCount'=>1), array("PROPERTY_RATING"));		if($ar_fields2 = $res2->GetNext()){			$arResult["BASKET_ITEMS"][$k]["RATING"] = $ar_fields2["PROPERTY_RATING_VALUE"];			//$arResult["BASKET_ITEMS"][$k]["URL"] = "/catalog/".$ar_fields2["IBLOCK_SECTION_ID"]."/".$ar_fields["PROPERTY_MAIN_PRODUCT_VALUE"]."/";		}	}		}}//print_R($arResult);?>